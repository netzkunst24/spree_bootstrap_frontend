<table>
  <tr>
    <td>
      <p class="lede">
        <%= Spree.t('order_mailer.confirm_email.dear_customer') %>
      </p>
      <%= simple_format(Spree.t('order_mailer.confirm_email.instructions')) %>

      <% if @order.payments.select { |p| p.payment_method.type == 'Spree::PaymentMethod::Check' }.present? %>
          <table class="twelve columns">
            <tr>
              <td class="panel">
                <p>Sie haben sich zur Zahlung per Vorkasse entschieden. Bitte überweisen Sie die Gesamtsumme auf folgendes Konto:</p>
                <p>Volksbank Lüneburger Heide<br>
                  BIC:  GENODEF1NBU<br>
                  IBAN: DE45 2406 0300 8523 0510 01<br>
                  Verwendugszweck: <%= @order.number %><br>
                  Betrag: <%= @order.display_total %>
                </p>
              </td>
              <td class="expander"></td>
            </tr>
          </table>

      <% end %>
      <table class="row">
        <tbody>
          <tr>
            <td class="wrapper">
              <br />
              <table class="twelve columns">
                <tbody>
                  <tr>
                    <td style="border-bottom:1px solid #ccc">
                      <h6><%= Spree.t('order_mailer.confirm_email.order_summary') %></h6>
                    </td>
                  </tr>
                </tbody>
              </table>
              <br />
              <table class="twelve columns">
                <tbody>
                  <tr>
                    <td class="six sub-columns">
                      Kundennummer: <%= "#{@order.user.id || 'A'}/#{@order.user.ship_address_id}/#{@order.user.bill_address_id}" %><br />
                      Bestellnummer: <%= @order.number %>
                    </td>
                    <td class="six sub-columns last">
                      Zahlart: <% @order.payments.valid.each do |payment| %>
                          <%= render payment%><br/>
                      <% end %>
                      Versand: Spedition
                    </td>
                    <td class="expander"></td>
                  </tr>
                  <tr>
                    <td class="six sub-columns">
                      Lieferung an:
                      <%= render :partial => 'spree/shared/address', :locals => { :address => @order.ship_address } %>
                    </td>
                    <td class="six sub-columns last">
                      Rechnung an:
                      <%= render :partial => 'spree/shared/address', :locals => { :address => @order.bill_address } %>
                    </td>
                    <td class="expander"></td>
                  </tr>
                </tbody>
              </table>

            </td>
          </tr>
        </tbody>
      </table>
      <br />
      <table class="twelve columns">
        <tbody>
        <tr>
          <td style="border-bottom:1px solid #ccc">
            <h6><%= Spree.t('order_mailer.confirm_email.article_summary') %></h6>
          </td>
        </tr>
        </tbody>
      </table>
      <br />
      <table class="twelve columns">
        <% @order.line_items.each do |item| %>
          <tr>
            <td class="eight sub-columns">
              <%= image_tag item.product.images.first.attachment.url(:small), width: '100', alt: '', style: 'width: 100px;' %>
              <%= raw(item.variant.product.name) %><br />
              <%= raw("#{item.variant.options_text}<br />") if item.variant.options_text.present? %>
              <%=item.quantity%> x <%= item.single_money %>
            </td>
            <td class="four sub-columns last" style="text-align: right;"><%= item.display_amount %></td>
          </tr>
        <% end %>
        <% if @order.line_item_adjustments.exists? %>
          <% if @order.all_adjustments.promotion.eligible.exists? %>
            <% @order.all_adjustments.promotion.eligible.group_by(&:label).each do |label, adjustments| %>
              <tr>
                <td class="eight sub-columns"><%= Spree.t(:promotion) %> <%= label %>:</td>
                <td class="four sub-columns last" style="text-align: right;"><%= Spree::Money.new(adjustments.sum(&:amount), currency: @order.currency) %></td>
              </tr>
            <% end %>
          <% end %>
        <% end %>
        <% @order.shipments.group_by { |s| s.selected_shipping_rate.try(:name) }.each do |name, shipments| %>
          <tr>
            <td class="eight sub-columns"><%= Spree.t(:shipping) %> <%= name %>:</td>
            <td class="four sub-columns last" style="text-align: right;"><%= Spree::Money.new(shipments.sum(&:cost), currency: @order.currency) %></td>
          </tr>
        <% end %>
        <% @order.adjustments.eligible.each do |adjustment| %>
          <% next if (adjustment.source_type == 'Spree::TaxRate') and (adjustment.amount == 0) %>
          <% next if (adjustment.source_type == 'Spree::Shipment') and (adjustment.amount == 0) %>
          <tr>
            <td class="eight sub-columns"><%= adjustment.label %>:</td>
            <td class="four sub-columns last" style="text-align: right;"><%= adjustment.display_amount %></td>
          </tr>
        <% end %>
        <tr>
          <td class="eight sub-columns" style="font-weight: bold;">
            Gesamtsumme <% if @order.all_adjustments.eligible.tax.exists? %>(inkl.
                <% @order.all_adjustments.eligible.tax.group_by(&:label).each do |label, adjustments| %><%= Spree::Money.new(adjustments.sum(&:amount), currency: @order.currency) %> <%= label %><% end %>)
        <% end %>
          </td>
          <td class="four sub-columns last" style="font-weight: bold; text-align: right;">
            <%= @order.display_total %>
          </td>
        </tr>
      </table>
        <%= simple_format(Spree.t('order_mailer.confirm_email.acceptance')) %>
      <br />
        <%= simple_format(Spree.t('order_mailer.confirm_email.thanks')) %>
      <br />
      <br />
      <%= raw Spree::Page.by_slug('/widerrufsbelehrung').first.try(:body) %>
    </td>
    <td class="expander"></td>
  </tr>
</table>